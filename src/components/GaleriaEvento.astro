---
import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import { galleryManifest, GALLERY_BASE_PATH } from '../data/gallery';

interface Props {
	edicion: string;
	title?: string;
	limit?: number;
	linkHref?: string;
	linkLabel?: string;
}

const {
	edicion,
	limit = 10,
	title = `Evento 10 de 10 ${edicion}`,
	linkHref = `/edicion-${edicion}`,
	linkLabel = 'VER FOTOS DEL EVENTO'
} = Astro.props as Props;

const maxImages = Number.isFinite(limit) && limit > 0 ? limit : undefined;

async function loadEditionImages(edition: string) {
	try {
		const editionDirUrl = new URL(`../../public/assets/img/galeria-evento/${edition}/`, import.meta.url);
		const editionDirPath = fileURLToPath(editionDirUrl);
		const dirEntries = await fs.readdir(editionDirPath, { withFileTypes: true });

		const imageEntries = await Promise.all(
			dirEntries
				.filter((entry) => entry.isFile())
				.filter((entry) => /\.(png|jpe?g|webp|avif|gif)$/i.test(entry.name))
				.map(async (entry) => {
					const filePath = path.join(editionDirPath, entry.name);
					const stats = await fs.stat(filePath);
					return {
						name: entry.name,
						mtime: stats.mtime.getTime()
					};
				})
		);

		const basePath = `/assets/img/galeria-evento/${edition}/`;

		return imageEntries
			.sort((a, b) => b.mtime - a.mtime)
			.slice(0, maxImages ?? imageEntries.length)
			.map((entry) => ({
				url: `${basePath}${entry.name}`,
				alt: `Galería evento ${edition}`
			}));
	} catch (error) {
		console.warn(`[GaleriaEvento] No se pudieron cargar imágenes para la edición ${edition}:`, error);
		return [];
	}
}

const manifestImages = galleryManifest[edicion];

const slides = manifestImages && manifestImages.length
	? manifestImages
		.slice(0, maxImages ?? manifestImages.length)
		.map((filename) => ({
			url: `${GALLERY_BASE_PATH}/${edicion}/${filename}`,
			alt: `Galería evento ${edicion}`
		}))
	: await loadEditionImages(edicion);
const sliderId = `slider-${Math.random().toString(36).slice(2, 10)}`;
---

{slides.length ? (
<section class="slider-section slider-block" data-slider-id={sliderId} data-slider-root>
		<div class="slider-inner">
			<div class="header-row">
				<h3 class="uppercase slider-title">{title}</h3>
				<div aria-hidden="true" class="nav-wrapper">
					<button class="nav-btn prev-btn" type="button" aria-label="Imagen anterior">
						<img src="assets/img/49edcabe46c24d4f3a5cc1fdbc205de78c54c11b.svg" alt="prev" />
					</button>
					<button class="nav-btn next-btn" type="button" aria-label="Imagen siguiente">
						<img src="assets/img/49edcabe46c24d4f3a5cc1fdbc205de78c54c11b.svg" alt="next" class="icon-rotate" />
					</button>
				</div>
			</div>
			<div class="slider-container">
				<div class="slider-track">
					{slides.map((slide) => (
						<div class="slider-item">
							<a href={linkHref} class="slide-link">
								<article class="card">
									<figure>
										<img src={slide.url} alt={slide.alt} loading="lazy" />
									</figure>
								</article>
							</a>
						</div>
					))}
				</div>
			</div>
			<div class="link-row">
				<a href={linkHref} class="link-more">{linkLabel}</a>
			</div>
		</div>
	</section>
) : null}

<style>
	[data-slider-root].slider-block {
		margin: 64px 0;
	}

	[data-slider-root].slider-section {
		--slider-edge-space: 0;
		background: transparent;
		padding: 48px 0;
	}

	[data-slider-root] .slider-inner {
		padding-left: 0;
		padding-right: 0;
	}

	[data-slider-root] .slider-container {
		padding-left: 0;
		padding-right: 0;
	}

	[data-slider-root] .slider-inner {
		max-width: 1700px;
		margin: 0 auto;
		width: 100%;
		padding-left: 16px;
		padding-right: 16px;
		box-sizing: border-box;
	}

	[data-slider-root] .slider-container {
		position: relative;
		margin-top: 0;
		overflow: hidden;
		padding-left: var(--slider-edge-space);
		padding-right: var(--slider-edge-space);
		box-sizing: border-box;
	}

	[data-slider-root] .header-row {
		display: flex;
		justify-content: space-between;
		align-items: center;
		border-bottom: 1px solid #000;
		padding-bottom: 10px;
		margin-bottom: 50px;
		gap: 16px;
		padding-left: var(--slider-edge-space);
		padding-right: var(--slider-edge-space);
		box-sizing: border-box;
	}

	[data-slider-root] .slider-title {
		margin: 0;
		font-weight: 700;
		font-size: 18px;
		color: var(--c-grey-16);
	}

	[data-slider-root] .nav-btn {
		background: none;
		border: none;
		width: 28px;
		height: 20px;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		padding: 0;
		transition: opacity 0.2s ease;
	}

	[data-slider-root] .nav-btn:hover {
		opacity: 0.7;
	}

	[data-slider-root] .nav-btn img {
		width: 22px;
		height: 14px;
		object-fit: contain;
		opacity: 0.6;
	}

	[data-slider-root] .icon-rotate {
		transform: rotate(180deg);
	}

	[data-slider-root] .slider-track {
		--slider-gap: clamp(8px, 2.5vw, 36px);
		display: flex;
		transition: transform 0.6s cubic-bezier(0.25, 0.8, 0.3, 1);
		gap: var(--slider-gap);
		padding: 0;
		touch-action: pan-y;
		cursor: grab;
	}

	[data-slider-root] .slider-item {
		flex: 0 0 100%;
		max-width: 100%;
		box-sizing: border-box;
	}

	[data-slider-root] .card {
		display: flex;
		flex-direction: column;
	}

	[data-slider-root] .card figure {
		margin: 0;
		aspect-ratio: 1 / 1;
		background: var(--c-grey-84);
		overflow: hidden;
	}

	[data-slider-root] .card figure img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	[data-slider-root] .nav-wrapper {
		display: flex;
		padding: 0;
		flex-direction: row;
		align-items: center;
		gap: 10px;
		margin-left: auto;
	}

	[data-slider-root] .link-row {
		margin-top: 24px;
		display: flex;
		justify-content: flex-end;
		padding-left: var(--slider-edge-space);
		padding-right: var(--slider-edge-space);
		box-sizing: border-box;
	}

	[data-slider-root] .link-more {
		color: var(--c-grey-46);
		font-weight: 700;
		text-transform: uppercase;
		text-decoration: none;
		font-size: 12px;
		letter-spacing: 0.02em;
		cursor: pointer;
	}

	[data-slider-root] .slide-link {
		display: block;
		text-decoration: none;
		color: inherit;
	}

	@media (min-width: 768px) {
		[data-slider-root] .slider-item {
			flex: 0 0 calc((100% - var(--slider-gap)) / 2);
			max-width: calc((100% - var(--slider-gap)) / 2);
		}
	}

	@media (min-width: 960px) {
		[data-slider-root] .slider-item {
			flex: 0 0 calc((100% - (var(--slider-gap) * 3)) / 4);
			max-width: calc((100% - (var(--slider-gap) * 3)) / 4);
		}
	}
</style>

<script is:inline>
	(() => {
		const initialized = new WeakSet();

		const initSlider = (root) => {
			if (initialized.has(root)) {
				return;
			}
			initialized.add(root);

			const sliderTrack = root.querySelector('.slider-track');
			if (!sliderTrack) {
				return;
			}

			const prevBtn = root.querySelector('.prev-btn');
			const nextBtn = root.querySelector('.next-btn');
			const sliderItems = Array.from(sliderTrack.children);
			if (!sliderItems.length) {
				return;
			}

			let resizeTimeout;
			let autoInterval = null;
			let visibleItemsCount = 1;
			let stepSize = 1;
			let currentIndex = 0;
			let isPointerDragging = false;
			let dragPointerId = null;
			let dragStartX = 0;
			let dragLatestX = 0;
			let baseTransform = 0;
			const DRAG_MIN_THRESHOLD = 30;

			function maxStartIndex() {
				return Math.max(sliderItems.length - visibleItemsCount, 0);
			}

			function clampIndex() {
				const maxIndex = maxStartIndex();
				if (currentIndex > maxIndex) {
					currentIndex = maxIndex;
				}
				if (currentIndex < 0) {
					currentIndex = maxIndex;
				}
			}

			function applyTransform(instant = false) {
				const target = sliderItems[currentIndex];
				const offset = target ? target.offsetLeft : 0;
				const translateValue = -offset;
				if (instant) {
					sliderTrack.style.transition = 'none';
				}
				sliderTrack.style.transform = `translateX(${translateValue}px)`;
				if (instant) {
					void sliderTrack.offsetWidth;
					sliderTrack.style.transition = '';
				}
			}

			function restartAutoplay() {
				if (autoInterval) {
					window.clearInterval(autoInterval);
					autoInterval = null;
				}
				if (sliderItems.length > visibleItemsCount) {
					autoInterval = window.setInterval(() => {
						nextSlide();
					}, 5000);
				}
			}

			function recalc() {
				const sliderContainer = sliderTrack.parentElement;
				const containerWidth = sliderContainer ? sliderContainer.getBoundingClientRect().width : 0;
				const viewportWidth = window.innerWidth || containerWidth;
				let desiredVisible = 1;
				if (viewportWidth >= 960) {
					desiredVisible = 4;
				} else if (viewportWidth >= 768) {
					desiredVisible = 2;
				}
				visibleItemsCount = Math.min(desiredVisible, sliderItems.length || 1);
				stepSize = 1;
				clampIndex();
				applyTransform(true);
				restartAutoplay();
			}

			function nextSlide() {
				if (sliderItems.length <= 1) {
					return;
				}
				currentIndex += stepSize;
				if (currentIndex > maxStartIndex()) {
					currentIndex = 0;
				}
				applyTransform();
			}

			function prevSlide() {
				if (sliderItems.length <= 1) {
					return;
				}
				currentIndex -= stepSize;
				if (currentIndex < 0) {
					currentIndex = maxStartIndex();
				}
				applyTransform();
			}

			function pointerDown(event) {
				const targetElement = event.target instanceof Element ? event.target : null;
				if (targetElement && targetElement.closest('a, button')) {
					return;
				}
				if (sliderItems.length <= visibleItemsCount) {
					return;
				}
				if (event.pointerType === 'mouse' && event.button !== 0) {
					return;
				}
				isPointerDragging = true;
				dragPointerId = event.pointerId;
				dragStartX = event.clientX;
				dragLatestX = dragStartX;
				const target = sliderItems[currentIndex];
				baseTransform = target ? -target.offsetLeft : 0;
				sliderTrack.style.transition = 'none';
				sliderTrack.style.cursor = 'grabbing';
				if (typeof sliderTrack.setPointerCapture === 'function') {
					sliderTrack.setPointerCapture(event.pointerId);
				}
				if (event.pointerType === 'touch') {
					event.preventDefault();
				}
				if (autoInterval) {
					window.clearInterval(autoInterval);
					autoInterval = null;
				}
			}

			function pointerMove(event) {
				if (!isPointerDragging || event.pointerId !== dragPointerId) {
					return;
				}
				dragLatestX = event.clientX;
				const delta = dragLatestX - dragStartX;
				sliderTrack.style.transform = `translateX(${baseTransform + delta}px)`;
				if (event.pointerType === 'touch') {
					event.preventDefault();
				}
			}

			function endPointerDrag(event) {
				if (!isPointerDragging || (event.pointerId != null && event.pointerId !== dragPointerId)) {
					return;
				}
				if (typeof sliderTrack.releasePointerCapture === 'function' && dragPointerId != null) {
					sliderTrack.releasePointerCapture(dragPointerId);
				}
				sliderTrack.style.cursor = '';
				sliderTrack.style.transition = '';
				const delta = dragLatestX - dragStartX;
				isPointerDragging = false;
				dragPointerId = null;
				const threshold = Math.max(DRAG_MIN_THRESHOLD, sliderItems[0]?.getBoundingClientRect().width * 0.12 || DRAG_MIN_THRESHOLD);
				if (Math.abs(delta) > threshold && sliderItems.length > visibleItemsCount) {
					if (delta < 0) {
						nextSlide();
					} else {
						prevSlide();
					}
				} else {
					applyTransform();
				}
				restartAutoplay();
			}

			sliderTrack.addEventListener('pointerdown', pointerDown, { passive: false });
			sliderTrack.addEventListener('pointermove', pointerMove, { passive: false });
			sliderTrack.addEventListener('pointerup', endPointerDrag);
			sliderTrack.addEventListener('pointercancel', endPointerDrag);
			sliderTrack.addEventListener('pointerleave', endPointerDrag);

			recalc();
			applyTransform(true);

			nextBtn?.addEventListener('click', () => {
				restartAutoplay();
				nextSlide();
			});

			prevBtn?.addEventListener('click', () => {
				restartAutoplay();
				prevSlide();
			});

			window.addEventListener('resize', () => {
				window.clearTimeout(resizeTimeout);
				resizeTimeout = window.setTimeout(recalc, 150);
			});

			restartAutoplay();
		};

		const setupAll = () => {
			document.querySelectorAll('[data-slider-root]').forEach((root) => initSlider(root));
		};

		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', setupAll, { once: true });
		} else {
			setupAll();
		}
	})();
</script>
